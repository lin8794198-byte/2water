<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>éº»å°‡å¤§å¸«ç¾¤ - é›²ç«¯åŒæ­¥ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            -webkit-tap-highlight-color: transparent;
            font-size: 0.95rem; 
            background-color: #FAF3E1; 
        }
        
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #F5E7C6; border-radius: 10px; }
        
        input[type="number"]::-webkit-inner-spin-button, 
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        select { appearance: none; text-align: center; border: 1px solid #F5E7C6; }
        
        .title-main { font-size: 1.5rem !important; }
        .tai-input-large { font-size: 2.25rem !important; }
        .stat-label { font-size: 0.75rem !important; }

        .text-orange { color: #FF6D1F; }
        .bg-orange { background-color: #FF6D1F; }
        .text-dark { color: #222222; }
        .bg-dark { background-color: #222222; }
        
        .card-shadow { box-shadow: 0 4px 12px rgba(34, 34, 34, 0.05); }

        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(250, 243, 225, 0.98);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 9999;
        }
    </style>
</head>
<body class="min-h-screen p-2 md:p-6 text-[#222222] pb-24 text-center">

    <!-- é›²ç«¯åŒæ­¥è®€å–é®ç½© -->
    <div id="loader" class="loading-overlay">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-[#FF6D1F]"></div>
        <p id="loader-text" class="mt-4 font-black text-[#FF6D1F]">æ­£åœ¨é€£ç·šé›²ç«¯è³‡æ–™åº«...</p>
    </div>

    <div class="max-w-4xl mx-auto space-y-4">
        <!-- Header -->
        <div class="bg-[#222222] p-5 rounded-2xl text-white shadow-xl flex flex-col md:flex-row justify-between items-center gap-4 text-center">
            <div class="flex items-center justify-center space-x-3 text-white">
                <div class="bg-white/10 p-2 rounded-xl border border-white/10">
                    <i data-lucide="cloud-lightning" class="w-6 h-6 text-[#FF6D1F]"></i>
                </div>
                <div class="text-left text-white">
                    <h1 class="font-black tracking-tight title-main text-white">éº»å°‡å¤§å¸«ç¾¤</h1>
                    <p class="text-[8px] opacity-40 uppercase tracking-widest">Real-time Cloud Sync</p>
                </div>
            </div>
            <div class="flex space-x-2">
                <button onclick="exportToCsv()" class="bg-[#FF6D1F] hover:opacity-90 px-4 py-2 rounded-xl transition-all flex items-center gap-2 font-bold text-xs text-white shadow-sm">
                    <i data-lucide="download" class="w-4 h-4 text-white"></i> åŒ¯å‡º CSV
                </button>
                <button onclick="resetData()" class="bg-white/10 hover:bg-white/20 p-2.5 rounded-xl transition-all text-white">
                    <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                </button>
            </div>
        </div>

        <!-- Global Stats Bar -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-center">
            <div class="bg-white p-3 rounded-xl border-2 border-[#F5E7C6] card-shadow">
                <label class="stat-label font-black text-slate-400 uppercase block mb-1">æ—¥æœŸ</label>
                <input type="date" id="session-date" onchange="updateState({sessionDate: this.value})" class="w-full font-bold text-[#222222] outline-none bg-transparent text-center text-sm">
            </div>
            <div class="bg-white p-3 rounded-xl border-2 border-[#F5E7C6] font-mono card-shadow">
                <label class="stat-label font-black text-slate-400 uppercase block mb-1">å°‡æ•¸</label>
                <p id="total-rounds" class="text-xl font-black text-[#222222] leading-none">0</p>
            </div>
            <div class="bg-white p-3 rounded-xl border-2 border-[#F5E7C6] font-mono card-shadow">
                <label class="stat-label font-black text-slate-400 uppercase block mb-1">æ±éŒ¢ (å°ç‚º)</label>
                <p id="total-dong" class="text-xl font-black text-[#FF6D1F] leading-none">$0</p>
            </div>
            <div class="bg-[#F5E7C6] p-3 rounded-xl text-[#222222] font-mono border border-[#FAF3E1]">
                <label class="stat-label font-black opacity-60 uppercase block mb-1">è¨­å®š</label>
                <p class="text-lg font-black tracking-widest leading-none">50 / 20</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 text-left">
            <div class="lg:col-span-7 space-y-6">
                <!-- 1. Player Selection -->
                <div class="bg-white p-5 rounded-2xl border-2 border-[#F5E7C6] card-shadow">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-sm font-black text-[#222222] uppercase flex items-center gap-2">
                            <i data-lucide="users" class="w-4 h-4 text-[#FF6D1F]"></i> 1. ä¸Šå ´ç©å®¶
                        </h2>
                        <span id="player-status-msg" class="text-[10px] font-bold text-[#FF6D1F] hidden italic">é›²ç«¯åŒæ­¥ä¸­</span>
                    </div>
                    <div id="player-selection-grid" class="grid grid-cols-5 gap-2 text-center text-white"></div>
                </div>

                <!-- 2. Record a Hand -->
                <div class="bg-white p-6 rounded-2xl border-2 border-[#F5E7C6] card-shadow relative overflow-hidden">
                    <h2 class="text-sm font-black text-[#222222] uppercase mb-4 flex items-center gap-2">
                        <i data-lucide="plus-circle" class="w-4 h-4 text-[#FF6D1F]"></i> 2. ç´€éŒ„èƒ¡ç‰Œ
                    </h2>
                    
                    <div class="space-y-4">
                        <div class="p-4 bg-[#FAF3E1] rounded-xl border border-[#F5E7C6] shadow-inner text-center">
                            <label class="text-[11px] font-black text-[#222222]/60 block mb-3 uppercase tracking-widest italic font-bold">ğŸ‘‘ æœ¬å±€èŠå®¶ (æ±å—è¥¿åŒ—)</label>
                            <div id="dealer-selection-container" class="grid grid-cols-4 gap-2 mb-4"></div>
                            
                            <div id="dealer-consecutive-container" class="hidden space-y-4 transition-all">
                                <div class="flex items-center justify-between bg-white p-3 rounded-xl border border-[#F5E7C6] shadow-sm">
                                    <span class="font-bold text-[#222222] text-xs">èŠå®¶é€£èŠæ•¸ï¼š</span>
                                    <input type="number" id="consecutive-input" value="0" min="0" max="20" onchange="updateConsecutiveWins(this.value)" class="w-16 bg-slate-50 border-none rounded text-lg font-black text-center py-1 outline-none focus:ring-2 focus:ring-[#FF6D1F] font-mono text-[#FF6D1F]">
                                </div>
                                <div class="bg-white p-3 rounded-xl border border-[#F5E7C6] shadow-sm">
                                    <div class="flex items-center justify-center gap-1.5 mb-2 text-[#222222]">
                                        <i data-lucide="eye" class="w-4 h-4 text-[#FF6D1F]"></i>
                                        <span class="font-bold text-xs">æœ¬å±€çœ¼ç‰Œåå–®ï¼š</span>
                                    </div>
                                    <div id="eye-watcher-grid" class="grid grid-cols-4 gap-2 text-white"></div>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4 text-[#222222]">
                            <div class="space-y-1">
                                <label class="text-xs font-black text-[#FF6D1F] text-center block uppercase font-bold">èƒ¡ç‰Œ</label>
                                <select id="winner-select" onchange="handleInputChange()" class="w-full bg-[#FAF3E1] border border-[#F5E7C6] rounded-xl p-3 font-black text-[#222222] outline-none focus:ring-2 focus:ring-[#FF6D1F] text-base shadow-sm h-12"></select>
                            </div>
                            <div class="space-y-1">
                                <label class="text-xs font-black text-[#222222]/60 text-center block uppercase font-bold">æ”¾æ§</label>
                                <select id="loser-select" onchange="handleInputChange()" class="w-full bg-[#FAF3E1] border border-[#F5E7C6] rounded-xl p-3 font-black text-[#222222] outline-none focus:ring-2 focus:ring-[#FF6D1F] text-base shadow-sm h-12"></select>
                            </div>
                        </div>
                    </div>

                    <div class="mt-8 flex items-end gap-3 text-center">
                        <div class="flex-1 space-y-1">
                            <label class="text-[10px] font-black text-slate-500 block text-center italic font-bold">è«‹è¼¸å…¥ç¸½å°æ•¸ (å«èŠé€£èŠå°)</label>
                            <input type="number" id="tai-input" placeholder="0" min="0" oninput="this.value = Math.abs(this.value)" class="w-full bg-slate-50 border border-[#F5E7C6] rounded-xl p-4 font-mono font-black tai-input-large text-center outline-none focus:ring-2 focus:ring-[#FF6D1F] shadow-inner text-[#222222]">
                        </div>
                        <div class="flex gap-1.5 pb-1">
                            <button id="btn-dice" onclick="toggleMod('dice')" class="p-3.5 rounded-xl border transition-all border-[#F5E7C6] bg-white text-slate-300 shadow-sm" title="éª°è¦ +2å°"><i data-lucide="dices" class="w-6 h-6"></i></button>
                            <button id="btn-leopard" onclick="toggleMod('leopard')" class="p-3.5 rounded-xl border transition-all border-[#F5E7C6] bg-white text-slate-300 shadow-sm" title="è±¹å­ x2"><i data-lucide="zap" class="w-6 h-6"></i></button>
                        </div>
                    </div>

                    <button onclick="addHand()" class="w-full mt-8 bg-[#FF6D1F] hover:opacity-90 text-white py-4 rounded-xl font-black btn-record flex items-center justify-center gap-3 shadow-xl active:scale-95 transition-all text-white border-b-4 border-[#222222]/20">
                        <i data-lucide="save" class="w-5 h-5 text-white"></i> è¨˜éŒ„é€™ç­†
                    </button>
                </div>

                <!-- 3. Current Progress -->
                <div class="bg-white p-5 rounded-2xl border-2 border-[#F5E7C6] card-shadow">
                    <div class="flex justify-between items-center mb-4 text-[#222222]">
                        <h2 class="text-sm font-black uppercase flex items-center gap-2 font-bold">
                            <i data-lucide="bar-chart-2" class="w-4 h-4 text-[#FF6D1F]"></i> 3. å³æ™‚è¨ˆåˆ†
                        </h2>
                        <div class="flex items-center gap-1">
                            <button onclick="undoAction()" id="undo-btn" title="ä¸Šä¸€æ­¥" class="flex items-center justify-center w-10 h-10 bg-[#FAF3E1] border border-[#F5E7C6] rounded-xl text-[#222222]/40 hover:text-[#FF6D1F] transition-all disabled:opacity-10">
                                <i data-lucide="undo-2" class="w-5 h-5"></i>
                            </button>
                            <button onclick="redoAction()" id="redo-btn" title="ä¸‹ä¸€æ­¥" class="flex items-center justify-center w-10 h-10 bg-[#FAF3E1] border border-[#F5E7C6] rounded-xl text-[#222222]/40 hover:text-[#FF6D1F] transition-all disabled:opacity-10">
                                <i data-lucide="redo-2" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                    <div id="current-summary-grid" class="grid grid-cols-4 gap-2 mb-6 text-center text-[#222222]"></div>
                    <div id="hands-list" class="space-y-2 max-h-[500px] overflow-y-auto mb-6 pr-1 custom-scrollbar text-[#222222]"></div>

                    <div class="pt-6 border-t border-[#F5E7C6] space-y-4 text-center">
                        <div class="flex items-center justify-between bg-[#F5E7C6] p-4 rounded-xl border border-[#FAF3E1]">
                            <span class="text-sm font-black text-[#222222] flex items-center gap-2">
                                <i data-lucide="coins" class="w-5 h-5 text-[#FF6D1F]"></i>æœ¬å°‡æ±éŒ¢ç´¯è¨ˆ
                            </span>
                            <div class="text-[#222222] font-black text-2xl font-mono" id="round-dong-display">$0</div>
                        </div>
                        <button onclick="finalizeRound()" class="w-full bg-[#222222] hover:bg-black text-white py-4 rounded-xl font-black btn-record flex items-center justify-center gap-3 shadow-lg active:scale-95 transition-all border-b-4 border-black">
                            <i data-lucide="check-square" class="w-5 h-5 text-[#FF6D1F]"></i> çµæŸæœ¬å°‡
                        </button>
                    </div>
                </div>
            </div>

            <!-- History Panel -->
            <div class="lg:col-span-5 space-y-4 text-left">
                <h2 class="text-sm font-black text-[#222222] uppercase flex items-center gap-2 px-2 text-black text-[#222222]">
                    <i data-lucide="history" class="w-4 h-4 text-[#FF6D1F]"></i> æ­·å²ç´€éŒ„
                </h2>
                <div id="history-list" class="space-y-4 max-h-[1400px] overflow-y-auto pr-1 pb-4 custom-scrollbar text-[#222222]"></div>
                
                <div id="settlement-container" class="space-y-4 hidden text-[#222222]">
                    <button onclick="calculateSettlement()" class="w-full bg-[#FF6D1F] hover:opacity-95 text-white py-4 rounded-xl font-black flex items-center justify-center gap-2 shadow-xl border-b-4 border-black/10 transition-all active:scale-95 font-bold">
                        <i data-lucide="wallet" class="w-5 h-5 text-white"></i> ç•¶æ—¥çµ±ä¸€çµå¸³
                    </button>
                    <div id="settlement-result" class="bg-white p-5 rounded-2xl border-2 border-[#F5E7C6] shadow-lg space-y-4 transition-all">
                        <div class="flex items-center justify-between border-b border-[#FAF3E1] pb-2">
                            <span class="text-xs font-black text-[#FF6D1F] uppercase tracking-widest">å»ºè­°åŒ¯æ¬¾æ–¹æ¡ˆ</span>
                            <span id="settle-date-label" class="text-[10px] font-bold text-slate-400"></span>
                        </div>
                        <div id="settle-balances-list" class="grid grid-cols-5 gap-1 border-b border-[#FAF3E1] pb-3 text-center text-[#222222]"></div>
                        <div id="settle-instructions" class="space-y-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, updateDoc, setDoc, collection, addDoc, deleteDoc, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // å·²å¡«å…¥æ‚¨çš„å°ˆå±¬ Firebase è¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyDfC4MaO8CVAJsbRFCjtHBm-ivH5NALzxo",
            authDomain: "mahjong-app-68ba7.firebaseapp.com",
            projectId: "mahjong-app-68ba7",
            storageBucket: "mahjong-app-68ba7.firebasestorage.app",
            messagingSenderId: "258855905073",
            appId: "1:258855905073:web:972183ad41a9a7b4b2f210",
            measurementId: "G-YYM6WX0VJZ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'mahjong-adam-room';

        // ç¬¦åˆ 6 æ®µ (Document) èˆ‡ 5 æ®µ (Collection) è¦ç¯„çš„è·¯å¾‘
        const getColl = (name) => collection(db, 'artifacts', appId, 'public', 'data', name);
        const globalRef = doc(db, 'artifacts', appId, 'public', 'data', 'config', 'globalState');
        
        const handsColl = getColl('hands');
        const historyColl = getColl('history');
        const redoColl = getColl('redo');

        const FIXED_PLAYERS = [{id:1,name:'é˜¿èŒ‚'},{id:2,name:'å°ç‚º'},{id:3,name:'é˜¿ä»'},{id:4,name:'æ¦®ç·¯'},{id:5,name:'Karl'}];
        const BASE_MONEY = 50, TAI_MONEY = 20, DONG_FEE = 20;

        let state = {
            sessionDate: new Date().toISOString().split('T')[0],
            selectedPlayerIds: [1, 2, 3, 4],
            consecutiveWins: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 },
            eyeWatchers: [],
            rounds: 0, totalDong: 0, roundHands: [], history: [],
            currentDealerId: null, isDiceReturn: false, isLeopard: false
        };

        // --- åˆå§‹åŒ– & æŒ‡æ•¸é€€é¿é€£ç·šæ©Ÿåˆ¶èˆ‡é©—è­‰ä¿®å¾© ---
        async function initAuthWithRetry(maxRetries = 5) {
            let delay = 1000;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    // å¦‚æœæœ‰è‡ªå®šç¾©æ¬Šæ–ä¸”æ¬Šæ–ä¸ç‚ºç©ºå­—ä¸²ï¼Œå…ˆå˜—è©¦ä½¿ç”¨å®ƒ
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token && __initial_auth_token.length > 0) {
                        try {
                            await signInWithCustomToken(auth, __initial_auth_token);
                            return;
                        } catch (tokenError) {
                            // å¦‚æœæ˜¯æ¬Šæ–ä¸åŒ¹é…éŒ¯èª¤ï¼Œç›´æ¥é€€å›åˆ°åŒ¿åç™»å…¥ï¼Œä¸è¦ç¹¼çºŒé‡è©¦æ¬Šæ–
                            if (tokenError.code === 'auth/custom-token-mismatch') {
                                console.warn("Custom token mismatch, falling back to anonymous.");
                                await signInAnonymously(auth);
                                return;
                            }
                            throw tokenError;
                        }
                    } else {
                        await signInAnonymously(auth);
                        return;
                    }
                } catch (error) {
                    if (i === maxRetries - 1) {
                        const lt = document.getElementById('loader-text');
                        if(lt) lt.innerHTML = '<p class="text-rose-500 font-bold">é›²ç«¯æˆæ¬Šå¤±æ•—ï¼šè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–å°ˆæ¡ˆè¨­å®šã€‚</p>';
                        throw error;
                    }
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
        }

        async function start() {
            try {
                await initAuthWithRetry();
                onAuthStateChanged(auth, (user) => {
                    if (user) setupSync();
                });
            } catch (e) { console.error(e); }
        }

        function setupSync() {
            onSnapshot(globalRef, (snap) => {
                if (snap.exists()) {
                    Object.assign(state, snap.data());
                    const sd = document.getElementById('session-date');
                    if(sd) sd.value = state.sessionDate;
                    renderAll();
                } else {
                    setDoc(globalRef, {
                        sessionDate: state.sessionDate, selectedPlayerIds: state.selectedPlayerIds,
                        consecutiveWins: state.consecutiveWins, rounds: 0, totalDong: 0, currentDealerId: null, eyeWatchers: []
                    });
                }
            }, (e) => handleSyncError("Global", e));

            onSnapshot(handsColl, (snap) => {
                state.roundHands = snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => b.timestamp - a.timestamp);
                renderAll();
                const loader = document.getElementById('loader');
                if(loader) loader.style.display = 'none';
            }, (e) => handleSyncError("Hands", e));

            onSnapshot(historyColl, (snap) => {
                state.history = snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => b.timestamp - a.timestamp);
                renderAll();
            }, (e) => handleSyncError("History", e));

            onSnapshot(redoColl, (snap) => {
                const btn = document.getElementById('redo-btn');
                if(btn) btn.disabled = snap.empty;
            });
        }

        function handleSyncError(type, err) {
            console.error(`${type} Sync Error:`, err);
            const lt = document.getElementById('loader-text');
            if (err.code === 'permission-denied' && lt) {
                lt.innerHTML = '<p class="text-rose-500 font-bold p-4">é›²ç«¯æ¬Šé™é­æ‹’ï¼šè«‹å°‡ Firestore Database è¦å‰‡è¨­ç‚ºæ¸¬è©¦æ¨¡å¼ã€‚</p>';
            }
        }

        // --- æ“ä½œå‡½æ•¸ ---
        window.updateState = (updates) => { if (auth.currentUser) updateDoc(globalRef, updates); };
        
        window.togglePlayer = (id) => { 
            if (state.roundHands.length > 0) return; 
            let ids = state.selectedPlayerIds.includes(id) ? state.selectedPlayerIds.filter(p => p !== id) : [...state.selectedPlayerIds, id].slice(0,4); 
            updateState({ selectedPlayerIds: ids }); 
        };

        window.setDealer = (id) => { 
            updateState({ currentDealerId: id, eyeWatchers: [] }); 
            const db = document.getElementById('dealer-consecutive-container');
            if(db) db.classList.remove('hidden'); 
        };

        window.updateConsecutiveWins = (val) => { 
            if (!state.currentDealerId) return; 
            let wins = {...state.consecutiveWins}; 
            wins[state.currentDealerId] = parseInt(val) || 0; 
            updateState({ consecutiveWins: wins }); 
        };

        window.toggleEyeWatcher = (id) => { 
            let eyes = state.eyeWatchers.includes(id) ? state.eyeWatchers.filter(e => e !== id) : [...state.eyeWatchers, id]; 
            updateState({ eyeWatchers: eyes }); 
        };

        window.toggleMod = (t) => {
            if(t === 'dice') { state.isDiceReturn = !state.isDiceReturn; state.isLeopard = false; }
            else { state.isLeopard = !state.isLeopard; state.isDiceReturn = false; }
            updateModifierUI();
        };

        window.addHand = async () => {
            if (!auth.currentUser) return;
            const winEl = document.getElementById('winner-select');
            const losEl = document.getElementById('loser-select');
            const taiEl = document.getElementById('tai-input');
            if(!winEl || !losEl || !taiEl) return;

            const winId = parseInt(winEl.value);
            const losVal = losEl.value;
            const taiIn = parseInt(taiEl.value);
            if (!winId || !losVal || isNaN(taiIn) || !state.currentDealerId) { alert("é¸æ“‡æœªå®Œæˆï¼"); return; }
            
            const curN = state.consecutiveWins[state.currentDealerId] || 0;
            const dealerStake = (curN === 0 ? 1 : 2 * curN + 1);
            const impacts = {}; state.selectedPlayerIds.forEach(id => impacts[id] = 0);
            const isSelf = losVal === 'all', diceTai = state.isDiceReturn ? 2 : 0, winEye = state.eyeWatchers.includes(winId);

            if (isSelf) {
                let winGain = 0;
                state.selectedPlayerIds.forEach(pid => {
                    if (pid === winId) return;
                    let pTai = (winId === state.currentDealerId || pid === state.currentDealerId) ? (taiIn + diceTai) : (Math.max(0, taiIn - dealerStake) + diceTai);
                    if (winEye) pTai += 1; if (state.eyeWatchers.includes(pid)) pTai += 1;
                    let money = 50 + (pTai * TAI_MONEY); if (state.isLeopard) money *= 2;
                    impacts[pid] = -money; winGain += money;
                });
                impacts[winId] = winGain - DONG_FEE;
            } else {
                let pTai = taiIn + diceTai; if (winEye) pTai += 1;
                let money = 50 + (pTai * TAI_MONEY); if (state.isLeopard) money *= 2;
                impacts[winId] = money; impacts[losVal] = -money;
                state.selectedPlayerIds.forEach(pid => { if (pid !== winId && pid !== parseInt(losVal) && state.eyeWatchers.includes(pid)) { impacts[pid] -= TAI_MONEY; impacts[winId] += TAI_MONEY; } });
            }

            await addDoc(handsColl, { winnerId: winId, loserId: losVal, tai: taiIn, dealerId: state.currentDealerId, consecutiveWins: curN, eyeWatchers: state.eyeWatchers, impacts, dong: isSelf ? DONG_FEE : 0, timestamp: Date.now(), isDiceReturn: state.isDiceReturn, isLeopard: state.isLeopard });
            const redos = await getDocs(redoColl); redos.forEach(d => deleteDoc(d.ref));

            let nWins = {...state.consecutiveWins}, nD = state.currentDealerId;
            if (winId === state.currentDealerId) nWins[winId]++; else { nWins[state.currentDealerId] = 0; const idx = state.selectedPlayerIds.indexOf(state.currentDealerId); nD = state.selectedPlayerIds[(idx + 1) % 4]; }
            updateState({ consecutiveWins: nWins, currentDealerId: nD, eyeWatchers: [] });
            resetForm();
        };

        window.undoAction = async () => {
            if (state.roundHands.length === 0 || !auth.currentUser) return;
            const last = state.roundHands[0];
            await addDoc(redoColl, {...last, timestamp: Date.now()});
            await deleteDoc(doc(handsColl, last.id));
            let wins = {...state.consecutiveWins}; wins[last.dealerId] = last.consecutiveWins;
            updateState({ consecutiveWins: wins, currentDealerId: last.dealerId, eyeWatchers: last.eyeWatchers });
        };

        window.redoAction = async () => {
            if (!auth.currentUser) return;
            const snap = await getDocs(query(redoColl, orderBy('timestamp', 'desc')));
            if (snap.empty) return;
            const data = snap.docs[0].data();
            await addDoc(handsColl, {...data, timestamp: Date.now()});
            await deleteDoc(snap.docs[0].ref);
        };

        window.finalizeRound = async () => {
            if (state.roundHands.length === 0 || !auth.currentUser) return;
            if (!confirm("ç¢ºå®šçµç®—æœ¬å°‡ï¼Ÿ")) return;
            const sc = {1:0,2:0,3:0,4:0,5:0}, st = { wins:{1:0,2:0,3:0,4:0,5:0}, selfDraws:{1:0,2:0,3:0,4:0,5:0}, losses:{1:0,2:0,3:0,4:0,5:0} };
            let dTot = 0;
            state.roundHands.forEach(h => { Object.keys(h.impacts).forEach(p => sc[p] += h.impacts[p]); dTot += h.dong; if (h.loserId === 'all') st.selfDraws[h.winnerId]++; else { st.wins[h.winnerId]++; st.losses[h.loserId]++; } });
            await addDoc(historyColl, { date: state.sessionDate, roundNumber: state.rounds + 1, players: state.selectedPlayerIds, scores: sc, stats: st, dong: dTot, timestamp: Date.now() });
            (await getDocs(handsColl)).forEach(d => deleteDoc(d.ref));
            updateState({ rounds: state.rounds + 1, totalDong: state.totalDong + dTot });
        };

        function resetForm() { 
            const ws = document.getElementById('winner-select');
            const ls = document.getElementById('loser-select');
            const ti = document.getElementById('tai-input');
            if(ws) ws.value = ""; if(ls) ls.value = ""; if(ti) ti.value = ""; 
            state.isDiceReturn = false; state.isLeopard = false; 
            updateModifierUI(); 
        }

        // --- æ¸²æŸ“ä»‹é¢ ---
        function renderAll() {
            const sum = {1:0,2:0,3:0,4:0,5:0}, st = {w:{1:0,2:0,3:0,4:0,5:0},m:{1:0,2:0,3:0,4:0,5:0},q:{1:0,2:0,3:0,4:0,5:0}};
            let rdD = 0;
            state.roundHands.forEach(h => { Object.keys(h.impacts).forEach(p => sum[p] += h.impacts[p]); rdD += h.dong; if (h.loserId === 'all') st.m[h.winnerId]++; else { st.w[h.winnerId]++; st.q[h.loserId]++; } });
            
            const tr = document.getElementById('total-rounds'); if(tr) tr.textContent = state.rounds;
            const td = document.getElementById('total-dong'); if(td) td.textContent = `$${state.totalDong}`;
            const rdd = document.getElementById('round-dong-display'); if(rdd) rdd.textContent = `$${rdD}`;
            const ubtn = document.getElementById('undo-btn'); if(ubtn) ubtn.disabled = state.roundHands.length === 0;
            
            const pg = document.getElementById('player-selection-grid');
            if(pg) pg.innerHTML = FIXED_PLAYERS.map(p => {
                const sel = state.selectedPlayerIds.includes(p.id);
                return `<button onclick="togglePlayer(${p.id})" class="py-4 rounded-xl font-bold border-2 transition-all ${sel?'bg-[#FF6D1F] border-transparent text-white shadow-md':'bg-white border-[#F5E7C6] text-slate-300'}"><span>${p.name}</span></button>`;
            }).join('');

            const seats = ["æ±","å—","è¥¿","åŒ—"];
            const dsc = document.getElementById('dealer-selection-container');
            if(dsc) dsc.innerHTML = state.selectedPlayerIds.map((p,i) => {
                const act = state.currentDealerId === p;
                return `<div class="flex flex-col gap-1 text-slate-400"><span class="stat-label text-center font-bold">${seats[i]}</span><button onclick="setDealer(${p})" class="py-3 rounded-xl font-bold border-2 ${act?'bg-[#222222] text-white shadow-md':'bg-white border-[#F5E7C6] text-slate-400'}">${FIXED_PLAYERS.find(x=>x.id==p).name}</button></div>`;
            }).join('');

            const ewg = document.getElementById('eye-watcher-grid');
            if (ewg) ewg.innerHTML = state.selectedPlayerIds.map(p => { const act = state.eyeWatchers.includes(p); return `<button onclick="toggleEyeWatcher(${p})" class="py-2.5 rounded-lg text-xs font-bold border ${act?'bg-[#FF6D1F] text-white':'bg-white border-[#F5E7C6] text-slate-400'}"><i data-lucide="eye" class="w-3 h-3"></i>${FIXED_PLAYERS.find(x=>x.id==p).name}</button>`; }).join('');

            const ws = document.getElementById('winner-select'), ls = document.getElementById('loser-select');
            if(ws && ls) {
                const curW = parseInt(ws.value), curL = ls.value;
                const psSelected = FIXED_PLAYERS.filter(p=>state.selectedPlayerIds.includes(p.id));
                ws.innerHTML = `<option value="">èƒ¡ç‰Œ</option>` + psSelected.map(p=>`<option value="${p.id}" ${curW==p.id?'selected':''}>${p.name}</option>`).join('');
                ls.innerHTML = `<option value="">æ”¾æ§</option><option value="all" ${curL=='all'?'selected':''}>ğŸŒŸ è‡ªæ‘¸</option>` + psSelected.filter(p=>p.id!=curW).map(p=>`<option value="${p.id}" ${curL==p.id?'selected':''}>${p.name}</option>`).join('');
            }

            const csg = document.getElementById('current-summary-grid');
            if(csg) csg.innerHTML = state.selectedPlayerIds.map(p => {
                const x = FIXED_PLAYERS.find(i=>i.id==p);
                return `<div class="bg-white p-3 rounded-2xl border-2 border-[#F5E7C6] shadow-sm"><p class="text-xs font-bold text-slate-800 mb-1">${x.name}</p><p class="text-lg font-black ${sum[p]>=0?'text-[#FF6D1F]':'text-[#222222]'}">${sum[p]>0?'+':''}${sum[p]}</p><div class="flex flex-col text-[8px] font-bold opacity-30 mt-1 text-[#222222]"><span>èƒ¡:${st.w[p]} / æ‘¸:${st.m[p]} / æ§:${st.q[p]}</span></div></div>`;
            }).join('');

            const hl = document.getElementById('hands-list');
            if(hl) {
                if(state.roundHands.length==0) hl.innerHTML = `<p class="py-6 opacity-20 italic text-center text-[#222222]">å°šç„¡é›²ç«¯ç´€éŒ„...</p>`;
                else hl.innerHTML = state.roundHands.map(h => {
                    let det = h.loserId=='all' ? `<p class="text-[9px] opacity-50 italic text-[#222222]">(${state.selectedPlayerIds.filter(i=>i!=h.winnerId).map(i=>FIXED_PLAYERS.find(x=>x.id==i).name+":"+h.impacts[i]).join(' / ')})</p>` : "";
                    return `<div class="p-4 bg-white rounded-xl border border-[#F5E7C6] flex justify-between items-center"><div class="text-left text-[#222222]"><div class="flex items-center gap-2 text-center font-bold text-[#222222]"><span class="bg-[#222222] text-white px-1.5 py-0.5 rounded text-[8px]">èŠ:${FIXED_PLAYERS.find(x=>x.id==h.dealerId).name}(${h.consecutiveWins})</span><span class="font-bold text-[#FF6D1F]">${FIXED_PLAYERS.find(x=>x.id==h.winnerId).name}</span><span class="text-xs text-[#222222]">${h.loserId=='all'?'è‡ªæ‘¸':'èƒ¡'+FIXED_PLAYERS.find(x=>x.id==h.loserId).name} ${h.tai}å°</span></div>${det}</div><div class="font-mono font-black ${h.impacts[h.winnerId]>=0?'text-[#FF6D1F]':'text-[#222222]'}">${h.impacts[h.winnerId]>0?'+':''}${h.impacts[h.winnerId]}</div></div>`;
                }).join('');
            }

            const hlist = document.getElementById('history-list');
            if(hlist) {
                if(state.history.length==0) hlist.innerHTML = `<div class="text-center py-10 opacity-20 italic text-sm text-[#222222]">å°šæœªæœ‰æ­·å²ç´€éŒ„</div>`;
                else {
                    hlist.innerHTML = state.history.map(r => `<div class="bg-white rounded-xl shadow border-2 border-[#F5E7C6] overflow-hidden text-[#222222]"><div class="bg-[#FAF3E1] px-4 py-2 border-b border-[#F5E7C6] flex justify-between items-center text-[#222222]"><span class="text-[10px] font-black opacity-40 text-[#222222]">ç¬¬ ${r.roundNumber} å°‡ â€¢ ${r.date}</span><span class="text-[10px] font-black text-[#FF6D1F]">$${r.dong}</span></div><div class="p-3 grid grid-cols-4 gap-1 text-center">${r.players.map(p => `<div><p class="text-[9px] opacity-40 font-bold text-[#222222]">${FIXED_PLAYERS.find(x=>x.id==p).name}</p><p class="text-xs font-black ${r.scores[p]>=0?'text-[#FF6D1F]':'text-[#222222]'}">${r.scores[p]}</p></div>`).join('')}</div></div>`).join('');
                    const sb = document.getElementById('settlement-container');
                    if(sb) sb.classList.remove('hidden');
                }
            }
            if(typeof lucide !== 'undefined') lucide.createIcons();
        }

        window.handleInputChange = () => {
            const winS = document.getElementById('winner-select'), losS = document.getElementById('loser-select'), taiI = document.getElementById('tai-input');
            if(!winS || !losS || !taiI || !state.currentDealerId) return;
            const w = parseInt(winS.value), l = losS.value;
            if(w == state.currentDealerId || (l != 'all' && parseInt(l) == state.currentDealerId)) taiI.value = (state.consecutiveWins[state.currentDealerId]==0?1:2*state.consecutiveWins[state.currentDealerId]+1);
            else if(l=='all') taiI.value = 1; else taiI.value = 0;
        };

        function updateModifierUI() {
            const bd = document.getElementById('btn-dice'), bl = document.getElementById('btn-leopard');
            if(bd) bd.className = state.isDiceReturn ? "p-3.5 rounded-xl border-2 bg-[#FF6D1F] text-white" : "p-3.5 rounded-xl border-2 bg-white text-slate-100";
            if(bl) bl.className = state.isLeopard ? "p-3.5 rounded-xl border-2 bg-[#222222] text-white" : "p-3.5 rounded-xl border-2 bg-white text-slate-100";
        }

        window.calculateSettlement = () => {
            const today = state.history.filter(r => r.date === state.sessionDate);
            const net = {1:0,2:0,3:0,4:0,5:0}; let dS = today.reduce((a, b) => a + (b.dong || 0), 0);
            today.forEach(r => Object.keys(r.scores).forEach(p => net[p] += r.scores[p])); net[2] += dS;
            
            const sdl = document.getElementById('settle-date-label'); if(sdl) sdl.textContent = `${state.sessionDate} ç•¶æ—¥çµå¸³`;
            const sbl = document.getElementById('settle-balances-list');
            if(sbl) sbl.innerHTML = FIXED_PLAYERS.map(p => `<div class="text-center text-[#222222]"><p class="text-[9px] font-bold opacity-40 text-[#222222]">${p.name}</p><p class="text-xs font-black ${net[p.id]>=0?'text-[#FF6D1F]':'text-[#222222]'}">${net[p.id]}</p></div>`).join('');
            
            const deb = [], cre = []; Object.keys(net).forEach(p => { if(net[p]<0) deb.push({n:FIXED_PLAYERS.find(x=>x.id==p).name,a:Math.abs(net[p])}); else if(net[p]>0) cre.push({n:FIXED_PLAYERS.find(x=>x.id==p).name,a:net[p]}); });
            const ins = []; let di=0, ci=0;
            while(di < deb.length && ci < cre.length) {
                let s = Math.min(deb[di].a, cre[ci].a); ins.push(`<div class="flex justify-between bg-[#FAF3E1] p-3 rounded-lg border border-[#F5E7C6] text-xs text-[#222222] font-bold"><span>${deb[di].n} ğŸ‘‰ <span class="text-[#FF6D1F]">${cre[ci].n}</span></span><span>$${s}</span></div>`);
                deb[di].a -= s; cre[ci].a -= s; if(deb[di].a===0) di++; if(cre[ci].a===0) ci++;
            }
            const si = document.getElementById('settle-instructions');
            if(si) si.innerHTML = ins.length ? ins.join('') : '<p class="text-center text-xs opacity-20 italic">å¸³ç›®å¹³è¡¡</p>';
        };

        window.exportToCsv = () => {
            let csv = "\ufeffæ—¥æœŸ,å°‡æ•¸,æ±éŒ¢,ç©å®¶,å¾—åˆ†\n";
            state.history.forEach(r => r.players.forEach(p => csv += `${r.date},ç¬¬${r.roundNumber}å°‡,${r.dong},${FIXED_PLAYERS.find(x => x.id === p).name},${r.scores[p]}\n`));
            const l = document.createElement("a"); l.href = URL.createObjectURL(new Blob([csv], {type:'text/csv;charset=utf-8;'})); l.download = `æˆ°ç¸¾åŒæ­¥_${state.sessionDate}.csv`; l.click();
        };

        window.resetData = async () => {
            if(!confirm('é€™æœƒæ¸…ç©ºé›²ç«¯æ‰€æœ‰æ•¸æ“šï¼Œç¢ºå®šï¼Ÿ')) return;
            await setDoc(globalRef, { sessionDate: state.sessionDate, selectedPlayerIds:[1,2,3,4], consecutiveWins:{1:0,2:0,3:0,4:0,5:0}, rounds:0, totalDong:0, currentDealerId:null, eyeWatchers:[] });
            const handsSnap = await getDocs(handsColl); handsSnap.forEach(d => deleteDoc(d.ref));
            const histSnap = await getDocs(historyColl); histSnap.forEach(d => deleteDoc(d.ref));
            const redoSnap = await getDocs(redoColl); redoSnap.forEach(d => deleteDoc(d.ref));
            location.reload();
        };

        start();
    </script>
</body>
</html>