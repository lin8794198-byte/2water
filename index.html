<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>éº»å°‡å¤§å¸«ç¾¤ - é›²ç«¯åŒæ­¥ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            -webkit-tap-highlight-color: transparent;
            font-size: 0.95rem; 
            background-color: #FAF3E1; 
        }
        
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #F5E7C6; border-radius: 10px; }
        
        input[type="number"]::-webkit-inner-spin-button, 
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        select { appearance: none; text-align: center; border: 1px solid #F5E7C6; }
        
        .title-main { font-size: 1.5rem !important; }
        .tai-input-large { font-size: 2.25rem !important; }
        .stat-label { font-size: 0.75rem !important; }

        .text-orange { color: #FF6D1F; }
        .bg-orange { background-color: #FF6D1F; }
        .text-dark { color: #222222; }
        .bg-dark { background-color: #222222; }
        
        .card-shadow { box-shadow: 0 4px 12px rgba(34, 34, 34, 0.05); }

        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(250, 243, 225, 1);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 9999;
        }

        .timeout-btn {
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #FF6D1F;
            color: white;
            border-radius: 10px;
            font-weight: bold;
            display: none;
            cursor: pointer;
        }

        .select-btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid #F5E7C6;
        }
        .select-btn.winner-active {
            background-color: #FF6D1F;
            border-color: #FF6D1F;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 109, 31, 0.3);
        }
        .select-btn.loser-active {
            background-color: #222222;
            border-color: #222222;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(34, 34, 34, 0.3);
        }
    </style>
</head>
<body class="min-h-screen p-2 md:p-6 text-[#222222] pb-24 text-center">

    <!-- é›²ç«¯åŒæ­¥è®€å–é®ç½© -->
    <div id="loader" class="loading-overlay">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-[#FF6D1F]"></div>
        <p id="loader-text" class="mt-4 font-black text-[#FF6D1F]">æ­£åœ¨é€£ç·šé›²ç«¯è³‡æ–™åº«...</p>
        <div id="timeout-action" onclick="closeLoader()" class="timeout-btn text-white font-bold">é€£ç·šéä¹…ï¼Ÿé»æ­¤å¼·åˆ¶é€²å…¥</div>
    </div>

    <div class="max-w-4xl mx-auto space-y-4">
        <!-- Header -->
        <div class="bg-[#222222] p-5 rounded-2xl text-white shadow-xl flex flex-col md:flex-row justify-between items-center gap-4 text-center text-white">
            <div class="flex items-center justify-center space-x-3">
                <div class="bg-white/10 p-2 rounded-xl border border-white/10">
                    <i data-lucide="cloud-lightning" class="w-6 h-6 text-[#FF6D1F]"></i>
                </div>
                <div class="text-left text-white">
                    <h1 class="font-black tracking-tight text-xl">éº»å°‡å¤§å¸«ç¾¤</h1>
                    <p class="text-[8px] opacity-40 uppercase tracking-widest text-white font-bold">Real-time Cloud Sync</p>
                </div>
            </div>
            <div class="flex space-x-2">
                <button onclick="exportToCsv()" class="bg-[#FF6D1F] hover:opacity-90 px-4 py-2 rounded-xl transition-all flex items-center gap-2 font-bold text-xs shadow-sm text-white">
                    <i data-lucide="download" class="w-4 h-4"></i> åŒ¯å‡º CSV
                </button>
                <button onclick="resetData()" class="bg-white/10 hover:bg-white/20 p-2.5 rounded-xl transition-all text-white">
                    <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                </button>
            </div>
        </div>

        <!-- Global Stats Bar -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-center">
            <div class="bg-white p-3 rounded-xl border-2 border-[#F5E7C6] card-shadow text-[#222222]">
                <label class="stat-label font-black text-slate-400 uppercase block mb-1">æ—¥æœŸ</label>
                <input type="date" id="session-date" onchange="updateState({sessionDate: this.value})" class="w-full font-bold text-[#222222] outline-none bg-transparent text-center text-sm">
            </div>
            <div class="bg-white p-3 rounded-xl border-2 border-[#F5E7C6] font-mono card-shadow text-[#222222]">
                <label class="stat-label font-black text-slate-400 uppercase block mb-1">ç´¯ç©å°‡æ•¸</label>
                <p id="total-rounds" class="text-xl font-black text-[#222222] leading-none">0</p>
            </div>
            <div class="bg-white p-3 rounded-xl border-2 border-[#F5E7C6] font-mono card-shadow text-[#222222]">
                <label class="stat-label font-black text-slate-400 uppercase block mb-1 text-slate-400">ç¸½æ±éŒ¢ (å°ç‚º)</label>
                <p id="total-dong" class="text-xl font-black text-[#FF6D1F] leading-none">$0</p>
            </div>
            <div class="bg-[#F5E7C6] p-3 rounded-xl text-[#222222] font-mono border border-[#FAF3E1]">
                <label class="stat-label font-black opacity-60 uppercase block mb-1">ä¿åº•å°æ•¸</label>
                <p class="text-lg font-black tracking-widest leading-none text-[#222222]">2n+1</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 text-left">
            <div class="lg:col-span-7 space-y-6">
                <!-- 1. Players Selection -->
                <div class="bg-white p-5 rounded-2xl border-2 border-[#F5E7C6] card-shadow">
                    <div class="flex justify-between items-center mb-4 text-[#222222]">
                        <h2 class="text-sm font-black uppercase flex items-center gap-2 font-bold"><i data-lucide="users" class="w-4 h-4 text-[#FF6D1F]"></i> 1. ä¸Šå ´ç©å®¶</h2>
                        <span id="player-status-msg" class="text-[10px] font-bold text-[#FF6D1F] hidden italic">é›²ç«¯åŒæ­¥ä¸­</span>
                    </div>
                    <div id="player-selection-grid" class="grid grid-cols-5 gap-2 text-center text-white"></div>
                </div>

                <!-- 2. Record a Hand -->
                <div class="bg-white p-6 rounded-2xl border-2 border-[#F5E7C6] card-shadow relative overflow-hidden">
                    <h2 class="text-sm font-black text-[#222222] uppercase mb-4 flex items-center gap-2 font-bold"><i data-lucide="plus-circle" class="w-4 h-4 text-[#FF6D1F]"></i> 2. ç´€éŒ„èƒ¡ç‰Œ</h2>
                    
                    <div class="space-y-6">
                        <!-- èŠå®¶ -->
                        <div class="p-4 bg-[#FAF3E1] rounded-xl border border-[#F5E7C6] shadow-inner text-center text-[#222222]">
                            <label class="text-[11px] font-black text-[#222222]/60 block mb-3 uppercase tracking-widest italic font-bold">ğŸ‘‘ æœ¬å±€èŠå®¶ (æ±å—è¥¿åŒ—)</label>
                            <div id="dealer-selection-container" class="grid grid-cols-4 gap-2 mb-4"></div>
                            <div id="dealer-consecutive-container" class="hidden space-y-4 transition-all">
                                <div class="flex items-center justify-between bg-white p-3 rounded-xl border border-[#F5E7C6] shadow-sm">
                                    <span class="font-bold text-[#222222] text-xs">èŠå®¶é€£èŠæ•¸ï¼š</span>
                                    <input type="number" id="consecutive-input" value="0" min="0" max="20" onchange="updateConsecutiveWins(this.value)" class="w-16 bg-slate-50 border-none rounded text-lg font-black text-center py-1 outline-none focus:ring-2 focus:ring-[#FF6D1F] font-mono text-[#FF6D1F]">
                                </div>
                                <div class="bg-white p-3 rounded-xl border border-[#F5E7C6] shadow-sm text-[#222222]">
                                    <div class="flex items-center justify-center gap-1.5 mb-2 font-bold text-xs"><i data-lucide="eye" class="w-4 h-4 text-[#FF6D1F]"></i>æœ¬å±€çœ¼ç‰Œåå–®</div>
                                    <div id="eye-watcher-grid" class="grid grid-cols-4 gap-2"></div>
                                </div>
                            </div>
                        </div>

                        <!-- èƒ¡ç‰Œ -->
                        <div class="space-y-2 text-center">
                            <label class="text-xs font-black text-[#FF6D1F] block uppercase tracking-widest font-bold">èƒ¡ç‰Œ</label>
                            <div id="winner-buttons-grid" class="grid grid-cols-4 gap-2"></div>
                        </div>

                        <!-- æ”¾æ§ -->
                        <div class="space-y-2 text-center">
                            <label class="text-xs font-black text-[#222222]/60 block uppercase tracking-widest font-bold">æ”¾æ§</label>
                            <div id="loser-buttons-grid" class="grid grid-cols-5 gap-1.5"></div>
                        </div>

                        <!-- å°æ•¸è¼¸å…¥ -->
                        <div class="mt-4 flex items-end gap-3 text-center text-[#222222]">
                            <div class="flex-1 space-y-1 text-center">
                                <label class="text-[10px] font-black text-slate-500 block text-center italic font-bold font-bold">è«‹è¼¸å…¥ç¸½å°æ•¸ (å«èŠé€£èŠå°)</label>
                                <input type="number" id="tai-input" value="0" min="0" oninput="this.value = Math.abs(this.value)" class="w-full bg-slate-50 border border-[#F5E7C6] rounded-xl p-4 font-mono font-black tai-input-large text-center outline-none focus:ring-2 focus:ring-[#FF6D1F] shadow-inner text-[#222222]">
                            </div>
                            <div class="flex gap-1.5 pb-1 text-white">
                                <button id="btn-dice" onclick="toggleMod('dice')" class="p-3.5 rounded-xl border transition-all border-[#F5E7C6] bg-white text-slate-300 shadow-sm" title="éª°è¦ +2å°"><i data-lucide="dices" class="w-6 h-6"></i></button>
                                <button id="btn-leopard" onclick="toggleMod('leopard')" class="p-3.5 rounded-xl border transition-all border-[#F5E7C6] bg-white text-slate-300 shadow-sm" title="è±¹å­ x2"><i data-lucide="zap" class="w-6 h-6"></i></button>
                            </div>
                        </div>

                        <button onclick="addHand()" class="w-full mt-2 bg-[#FF6D1F] hover:opacity-90 text-white py-4 rounded-xl font-black shadow-xl active:scale-95 transition-all border-b-4 border-[#222222]/20 font-bold text-white">è¨˜éŒ„é€™ç­†æ•¸æ“š</button>
                    </div>
                </div>

                <!-- Current Table -->
                <div class="bg-white p-5 rounded-2xl border-2 border-[#F5E7C6] card-shadow">
                    <div class="flex justify-between items-center mb-4 text-[#222222]">
                        <h2 class="text-sm font-black uppercase flex items-center gap-2 font-bold font-bold"><i data-lucide="bar-chart-2" class="w-4 h-4 text-[#FF6D1F]"></i> 3. å³æ™‚è¨ˆåˆ†</h2>
                        <div class="flex items-center gap-1 text-[#222222]">
                            <button onclick="undoAction()" id="undo-btn" class="flex items-center justify-center w-10 h-10 bg-[#FAF3E1] border border-[#F5E7C6] rounded-xl text-[#222222]/40 hover:text-[#FF6D1F] transition-all disabled:opacity-10"><i data-lucide="undo-2" class="w-5 h-5"></i></button>
                            <button onclick="redoAction()" id="redo-btn" class="flex items-center justify-center w-10 h-10 bg-[#FAF3E1] border border-[#F5E7C6] rounded-xl text-[#222222]/40 hover:text-[#FF6D1F] transition-all disabled:opacity-10"><i data-lucide="redo-2" class="w-5 h-5"></i></button>
                        </div>
                    </div>
                    <div id="current-summary-grid" class="grid grid-cols-4 gap-2 mb-6 text-center text-[#222222]"></div>
                    <div id="hands-list" class="space-y-2 max-h-[500px] overflow-y-auto mb-6 pr-1 custom-scrollbar text-[#222222]"></div>
                    <div class="pt-6 border-t border-[#F5E7C6] space-y-4 text-center">
                        <div class="flex items-center justify-between bg-[#F5E7C6] p-4 rounded-xl border border-[#FAF3E1] text-[#222222] font-bold"><span class="text-sm flex items-center gap-2"><i data-lucide="coins" class="w-5 h-5 text-[#FF6D1F]"></i>æœ¬å°‡æ±éŒ¢ç´¯è¨ˆ</span><div class="font-black text-2xl font-mono text-[#222222]" id="round-dong-display">$0</div></div>
                        <button onclick="finalizeRound()" class="w-full bg-[#222222] hover:bg-black text-white py-4 rounded-xl font-black shadow-lg active:scale-95 transition-all border-b-4 border-black font-bold text-white">çµæŸæœ¬å°‡</button>
                    </div>
                </div>
            </div>

            <!-- History Panel (ç•¶æ—¥ç´€éŒ„) -->
            <div class="lg:col-span-5 space-y-4 text-left">
                <h2 class="text-sm font-black text-[#222222] uppercase flex items-center gap-2 px-2 font-bold font-bold"><i data-lucide="calendar-check" class="w-4 h-4 text-[#FF6D1F]"></i> ç•¶æ—¥ç´€éŒ„</h2>
                <div id="history-list" class="space-y-4 max-h-[1400px] overflow-y-auto pr-1 pb-4 custom-scrollbar text-[#222222]"></div>
                <div id="settlement-container" class="space-y-4 hidden text-[#222222]">
                    <button onclick="calculateSettlement()" class="w-full bg-[#FF6D1F] hover:opacity-95 text-white py-4 rounded-xl font-black flex items-center justify-center gap-2 shadow-xl border-b-4 border-black/10 transition-all active:scale-95 font-bold font-bold text-white"><i data-lucide="wallet" class="w-5 h-5 text-white"></i> ç•¶æ—¥çµ±ä¸€çµå¸³</button>
                    <div id="settlement-result" class="bg-white p-5 rounded-2xl border-2 border-[#F5E7C6] shadow-lg space-y-4 transition-all">
                        <div class="flex items-center justify-between border-b border-[#FAF3E1] pb-2 font-bold text-[#222222]"><span class="text-xs font-black text-[#FF6D1F]">å»ºè­°åŒ¯æ¬¾æ–¹æ¡ˆ</span><span id="settle-date-label" class="text-[10px] font-bold text-slate-400"></span></div>
                        <div id="settle-balances-list" class="grid grid-cols-5 gap-1 border-b border-[#FAF3E1] pb-3 text-center text-[#222222]"></div>
                        <div id="settle-instructions" class="space-y-2 text-[#222222]"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, updateDoc, setDoc, collection, addDoc, deleteDoc, getDocs, query, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDfC4MaO8CVAJsbRFCjtHBm-ivH5NALzxo",
            authDomain: "mahjong-app-68ba7.firebaseapp.com",
            projectId: "mahjong-app-68ba7",
            storageBucket: "mahjong-app-68ba7.firebasestorage.app",
            messagingSenderId: "258855905073",
            appId: "1:258855905073:web:972183ad41a9a7b4b2f210",
            measurementId: "G-YYM6WX0VJZ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'mahjong-adam-room-exclusive-sync'; 

        const rootPath = ['artifacts', appId, 'public', 'data'];
        const globalRef = doc(db, ...rootPath, 'config', 'globalState');
        const handsColl = collection(db, ...rootPath, 'hands');
        const histColl = collection(db, ...rootPath, 'history');
        const redoColl = collection(db, ...rootPath, 'redo');

        const FIXED_PLAYERS = [{id:1,name:'é˜¿èŒ‚'},{id:2,name:'å°ç‚º'},{id:3,name:'é˜¿ä»'},{id:4,name:'æ¦®ç·¯'},{id:5,name:'Karl'}];
        const BASE_MONEY = 50, TAI_MONEY = 20, DONG_FEE = 20;

        let state = {
            sessionDate: new Date().toISOString().split('T')[0],
            selectedPlayerIds: [1, 2, 3, 4],
            consecutiveWins: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 },
            eyeWatchers: [],
            rounds: 0, totalDong: 0, roundHands: [], history: [],
            currentDealerId: null, isDiceReturn: false, isLeopard: false,
            tempWinnerId: null, tempLoserId: null
        };

        const getPlayerName = (id) => FIXED_PLAYERS.find(p => p.id == id)?.name || 'æœªçŸ¥';
        window.closeLoader = () => { if(document.getElementById('loader')) document.getElementById('loader').style.display = 'none'; };

        async function init() {
            setTimeout(() => { if(document.getElementById('timeout-action')) document.getElementById('timeout-action').style.display = 'block'; }, 6000);
            onAuthStateChanged(auth, async (user) => {
                if (!user) { try { await signInAnonymously(auth); } catch(e) { console.error(e); } return; }
                setupSync();
                closeLoader(); 
            });
        }

        function setupSync() {
            onSnapshot(globalRef, (snap) => {
                if (snap.exists()) {
                    const data = snap.data();
                    Object.assign(state, data);
                    if(document.getElementById('session-date')) document.getElementById('session-date').value = state.sessionDate;
                    renderAll();
                } else {
                    setDoc(globalRef, { sessionDate: state.sessionDate, selectedPlayerIds: state.selectedPlayerIds, consecutiveWins: state.consecutiveWins, rounds: 0, totalDong: 0, currentDealerId: null, eyeWatchers: [] });
                }
            });
            onSnapshot(handsColl, (snap) => { state.roundHands = snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => b.ts - a.ts); renderAll(); });
            onSnapshot(histColl, (snap) => { state.history = snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => b.ts - a.ts); renderAll(); });
            onSnapshot(redoColl, (snap) => { if(document.getElementById('redo-btn')) document.getElementById('redo-btn').disabled = snap.empty; });
        }

        window.updateState = (u) => { if (auth.currentUser) setDoc(globalRef, u, { merge: true }); };
        
        window.pickWinner = (id) => {
            state.tempWinnerId = (state.tempWinnerId === id) ? null : id;
            if (state.tempWinnerId === state.tempLoserId) state.tempLoserId = null;
            autoFillTai(); renderAll();
        };

        window.pickLoser = (val) => {
            state.tempLoserId = (state.tempLoserId === val) ? null : val;
            autoFillTai(); renderAll();
        };

        function autoFillTai() {
            const input = document.getElementById('tai-input');
            if(!input || !state.currentDealerId) return;
            if(state.tempWinnerId === state.currentDealerId || (state.tempLoserId !== 'all' && parseInt(state.tempLoserId) === state.currentDealerId)) {
                const n = state.consecutiveWins[state.currentDealerId] || 0;
                input.value = (2 * n + 1);
            } else if (state.tempLoserId === 'all') { input.value = 1; }
            else { input.value = 0; }
        }

        window.togglePlayer = (id) => { if (state.roundHands.length > 0) return; let ids = state.selectedPlayerIds.includes(id) ? state.selectedPlayerIds.filter(p => p !== id) : [...state.selectedPlayerIds, id].slice(0,4); updateState({ selectedPlayerIds: ids }); };
        window.setDealer = (id) => { updateState({ currentDealerId: id, eyeWatchers: [] }); };
        window.updateConsecutiveWins = (v) => { if (!state.currentDealerId) return; let wins = {...state.consecutiveWins}; wins[state.currentDealerId] = parseInt(v) || 0; updateState({ consecutiveWins: wins }); };
        window.toggleEyeWatcher = (id) => { let eyes = state.eyeWatchers.includes(id) ? state.eyeWatchers.filter(e => e !== id) : [...state.eyeWatchers, id]; updateState({ eyeWatchers: eyes }); };
        window.toggleMod = (t) => { if(t === 'dice') { state.isDiceReturn = !state.isDiceReturn; state.isLeopard = false; } else { state.isLeopard = !state.isLeopard; state.isDiceReturn = false; } renderAll(); };

        window.addHand = async () => {
            if (!auth.currentUser) return;
            let taiVal = document.getElementById('tai-input').value;
            if (taiVal === "") taiVal = "0";
            const taiIn = parseInt(taiVal);
            if (!state.tempWinnerId || !state.tempLoserId || isNaN(taiIn) || !state.currentDealerId) { alert("è«‹é»é¸è´å®¶èˆ‡è¼¸å®¶ï¼"); return; }
            
            const winId = state.tempWinnerId;
            const losVal = state.tempLoserId;
            const curN = state.consecutiveWins[state.currentDealerId] || 0;
            const ds = (2 * curN + 1);
            const imp = {}; state.selectedPlayerIds.forEach(id => imp[id] = 0);
            const isSelf = losVal === 'all', diceTai = state.isDiceReturn ? 2 : 0, winEye = state.eyeWatchers.includes(winId);

            if (isSelf) {
                let winG = 0;
                state.selectedPlayerIds.forEach(pid => {
                    if (pid === winId) return;
                    let pt = (winId === state.currentDealerId || pid === state.currentDealerId) ? (taiIn + diceTai) : (Math.max(0, taiIn - ds) + diceTai);
                    if (winEye) pt += 1; if (state.eyeWatchers.includes(pid)) pt += 1;
                    let m = BASE_MONEY + (pt * TAI_MONEY); if (state.isLeopard) m *= 2;
                    imp[pid] = -m; winG += m;
                });
                imp[winId] = winG - DONG_FEE;
            } else {
                let pt = taiIn + diceTai; if (winEye) pt += 1;
                let m = BASE_MONEY + (pt * TAI_MONEY); if (state.isLeopard) m *= 2;
                imp[winId] = m; imp[losVal] = -m;
                state.selectedPlayerIds.forEach(pid => { if (pid !== winId && pid !== parseInt(losVal) && state.eyeWatchers.includes(pid)) { imp[pid] -= TAI_MONEY; imp[winId] += TAI_MONEY; } });
            }

            await addDoc(handsColl, { winId, losId: losVal, tai: taiIn, dealerId: state.currentDealerId, n: curN, eyes: state.eyeWatchers, imp, dong: isSelf ? DONG_FEE : 0, ts: Date.now(), dice: state.isDiceReturn, leo: state.isLeopard });
            (await getDocs(redoColl)).forEach(d => deleteDoc(d.ref));
            let nextW = {...state.consecutiveWins}, nextD = state.currentDealerId;
            if (winId === state.currentDealerId) nextW[winId]++;
            else { nextW[state.currentDealerId] = 0; let idx = state.selectedPlayerIds.indexOf(state.currentDealerId); nextD = state.selectedPlayerIds[(idx + 1) % 4]; }
            updateState({ consecutiveWins: nextW, currentDealerId: nextD, eyeWatchers: [] });
            state.tempWinnerId = null; state.tempLoserId = null;
            document.getElementById('tai-input').value = "0"; state.isDiceReturn = false; state.isLeopard = false; renderAll();
        };

        window.deleteHand = async (id) => {
            if (!auth.currentUser) return;
            if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ")) return;
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'hands', id));
        };

        window.undoAction = async () => {
            if (state.roundHands.length === 0 || !auth.currentUser) return;
            const last = state.roundHands[0];
            await addDoc(redoColl, {...last, ts: Date.now()});
            await deleteDoc(doc(handsColl, last.id));
            let wins = {...state.consecutiveWins}; wins[last.dealerId] = last.n;
            updateState({ consecutiveWins: wins, currentDealerId: last.dealerId, eyeWatchers: last.eyes });
        };

        window.redoAction = async () => {
            if (!auth.currentUser) return;
            const snap = await getDocs(query(redoColl, orderBy('ts', 'desc')));
            if (snap.empty) return;
            const data = snap.docs[0].data();
            await addDoc(handsColl, {...data, ts: Date.now()});
            await deleteDoc(snap.docs[0].ref);
        };

        window.finalizeRound = async () => {
            if (state.roundHands.length === 0 || !auth.currentUser) return;
            if (!confirm("ç¢ºå®šçµç®—æœ¬å°‡ï¼Ÿè³‡æ–™å°‡è½‰å…¥æ­·å²ä¸¦æ¸…ç©ºæ¡Œé¢ã€‚")) return;
            const sc = {1:0,2:0,3:0,4:0,5:0}, st = { wins:{1:0,2:0,3:0,4:0,5:0}, selfDraws:{1:0,2:0,3:0,4:0,5:0}, losses:{1:0,2:0,3:0,4:0,5:0} };
            let dTot = 0;
            state.roundHands.forEach(h => {
                Object.keys(h.imp).forEach(p => sc[p] = (sc[p] || 0) + h.imp[p]);
                dTot += (h.dong || 0);
                if (h.losId === 'all') st.selfDraws[h.winId]++; else { st.wins[h.winId]++; st.losses[h.losId]++; }
            });

            await addDoc(histColl, { date: state.sessionDate, roundNumber: state.rounds + 1, players: state.selectedPlayerIds, scores: sc, stats: st, dong: dTot, ts: Date.now() });
            const snaps = await getDocs(handsColl);
            const batch = writeBatch(db);
            snaps.forEach(d => batch.delete(d.ref));
            await batch.commit();
            updateState({ rounds: state.rounds + 1, totalDong: state.totalDong + dTot });
        };

        function renderAll() {
            const sum = {1:0,2:0,3:0,4:0,5:0}, st = {w:{1:0,2:0,3:0,4:0,5:0},m:{1:0,2:0,3:0,4:0,5:0},q:{1:0,2:0,3:0,4:0,5:0}};
            let rdD = 0;
            state.roundHands.forEach(h => { Object.keys(h.imp).forEach(p => sum[p] = (sum[p] || 0) + h.imp[p]); rdD += (h.dong || 0); if (h.losId === 'all') st.m[h.winId]++; else { st.w[h.winId]++; st.q[h.losId]++; } });
            
            document.getElementById('total-rounds').textContent = state.rounds;
            document.getElementById('total-dong').textContent = `$${state.totalDong}`;
            document.getElementById('round-dong-display').textContent = `$${rdD}`;
            document.getElementById('undo-btn').disabled = state.roundHands.length === 0;
            
            document.getElementById('player-selection-grid').innerHTML = FIXED_PLAYERS.map(p => {
                const sel = state.selectedPlayerIds.includes(p.id);
                return `<button onclick="togglePlayer(${p.id})" class="py-4 rounded-xl font-bold border-2 transition-all ${sel?'bg-[#FF6D1F] border-transparent text-white shadow-md font-bold':'bg-white border-[#F5E7C6] text-slate-300'}"><span>${p.name}</span></button>`;
            }).join('');

            const sts = ["æ±","å—","è¥¿","åŒ—"];
            document.getElementById('dealer-selection-container').innerHTML = state.selectedPlayerIds.map((p,i) => {
                const act = state.currentDealerId === p;
                return `<div class="flex flex-col gap-1 text-slate-400 font-bold"><span class="stat-label text-center font-bold text-[#222222]/60">${sts[i]}</span><button onclick="setDealer(${p})" class="py-3 rounded-xl font-bold border-2 transition-all ${act?'bg-[#222222] border-[#222222] text-white shadow-md font-bold':'bg-white border-[#F5E7C6] text-slate-400'}">${getPlayerName(p)}</button></div>`;
            }).join('');
            if(state.currentDealerId) document.getElementById('dealer-consecutive-container').classList.remove('hidden');

            const eye = document.getElementById('eye-watcher-grid');
            if (eye) eye.innerHTML = state.selectedPlayerIds.map(p => { const act = state.eyeWatchers.includes(p); return `<button onclick="toggleEyeWatcher(${p})" class="py-2.5 rounded-lg text-xs font-bold border ${act?'bg-[#FF6D1F] text-white shadow-sm':'bg-white border-[#F5E7C6] text-slate-400'}"><i data-lucide="eye" class="w-3 h-3 inline mr-1"></i>${getPlayerName(p)}</button>`; }).join('');

            const psSelected = FIXED_PLAYERS.filter(p=>state.selectedPlayerIds.includes(p.id));
            document.getElementById('winner-buttons-grid').innerHTML = psSelected.map(p => `<button onclick="pickWinner(${p.id})" class="select-btn py-4 rounded-xl font-black text-sm ${state.tempWinnerId === p.id ? 'winner-active' : 'bg-white text-slate-400'} font-bold">${p.name}</button>`).join('');
            document.getElementById('loser-buttons-grid').innerHTML = `<button onclick="pickLoser('all')" class="select-btn py-4 rounded-xl font-black text-sm ${state.tempLoserId === 'all' ? 'loser-active' : 'bg-white text-slate-400'} font-bold">ğŸŒŸè‡ªæ‘¸</button>` + psSelected.map(p => {
                const isWin = state.tempWinnerId === p.id;
                return `<button onclick="${isWin ? '' : `pickLoser(${p.id})`}" class="select-btn py-4 rounded-xl font-black text-sm ${state.tempLoserId === p.id ? 'loser-active' : 'bg-white text-slate-400'} ${isWin ? 'opacity-10 cursor-not-allowed' : ''} font-bold">${p.name}</button>`;
            }).join('');

            document.getElementById('current-summary-grid').innerHTML = state.selectedPlayerIds.map(p => `<div class="bg-white p-3 rounded-2xl border-2 border-[#F5E7C6] shadow-sm font-bold"><p class="text-xs text-slate-800 mb-1 font-bold text-center">${getPlayerName(p)}</p><p class="text-lg ${sum[p]>=0?'text-[#FF6D1F]':'text-[#222222]'} text-center">${sum[p]>0?'+':''}${sum[p]}</p><div class="flex flex-col text-[8px] opacity-30 mt-1 text-center font-bold"><span>èƒ¡:${st.w[p]} / æ‘¸:${st.m[p]} / æ§:${st.q[p]}</span></div></div>`).join('');
            
            document.getElementById('hands-list').innerHTML = state.roundHands.length==0 ? `<p class="py-6 opacity-20 italic text-center text-[#222222]">å°šç„¡ç´€éŒ„...</p>` : state.roundHands.map(h => {
                const winName = getPlayerName(h.winId);
                const losName = h.losId == 'all' ? 'è‡ªæ‘¸' : 'èƒ¡' + getPlayerName(h.losId);
                let det = h.losId=='all' ? `<p class="text-[9px] opacity-50 italic text-[#222222] font-bold">(${state.selectedPlayerIds.filter(i=>i!=h.winId).map(i=>getPlayerName(i)+":"+h.imp[i]).join(' / ')})</p>` : "";
                return `<div class="p-4 bg-white rounded-xl border border-[#F5E7C6] flex justify-between items-center"><div class="text-left text-[#222222]"><div class="flex items-center gap-2 text-center font-bold text-[#222222] font-black"><span class="bg-[#222222] text-white px-1.5 py-0.5 rounded text-[8px]">èŠ:${getPlayerName(h.dealerId)}(${h.n})</span><span class="font-bold text-[#FF6D1F]">${winName}</span><span class="text-xs text-[#222222] font-bold">${losName} ${h.tai}å°</span></div>${det}</div><div class="flex items-center gap-3 font-mono font-black ${h.imp[h.winId]>=0?'text-[#FF6D1F]':'text-[#222222]'}">${h.imp[h.winId]>0?'+':''}${h.imp[h.winId]}<button onclick="deleteHand('${h.id}')" class="text-slate-200 hover:text-rose-500 transition-colors p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></div>`;
            }).join('');

            // --- ç•¶æ—¥ç´€éŒ„æ¸²æŸ“ ---
            const filteredHistory = state.history.filter(r => r.date === state.sessionDate);
            const hlist = document.getElementById('history-list');
            if(hlist) {
                if(filteredHistory.length==0) hlist.innerHTML = `<div class="text-center py-10 opacity-20 italic text-sm text-[#222222] font-bold">å°šæœªæœ‰æœ¬æ—¥ç´€éŒ„</div>`;
                else hlist.innerHTML = filteredHistory.map(r => `<div class="bg-white rounded-xl shadow border-2 border-[#F5E7C6] overflow-hidden font-bold"><div class="bg-[#FAF3E1] px-4 py-2 border-b border-[#F5E7C6] flex justify-between items-center text-[#222222]"><span class="text-[10px] opacity-40 font-bold">ç¬¬ ${r.roundNumber} å°‡ â€¢ ${r.date}</span><span class="text-[10px] text-[#FF6D1F] font-black">$${r.dong}</span></div><div class="p-3 grid grid-cols-4 gap-1 text-center font-bold">${r.players.map(p => `<div><p class="text-[9px] opacity-40 font-bold">${getPlayerName(p)}</p><p class="text-xs ${r.scores[p]>=0?'text-[#FF6D1F]':'text-[#222222]'}">${r.scores[p]}</p><div class="flex flex-col text-[7px] opacity-20 mt-1 font-bold"><span>èƒ¡:${r.stats.wins[p]}</span><span>æ‘¸:${r.stats.selfDraws[p]}</span><span>æ§:${r.stats.losses[p]}</span></div></div>`).join('')}</div></div>`).join('');
                const sc = document.getElementById('settlement-container'); if(sc && filteredHistory.length > 0) sc.classList.remove('hidden'); else sc.classList.add('hidden');
            }

            document.getElementById('btn-dice').className = state.isDiceReturn ? "p-3.5 rounded-xl border-2 bg-[#FF6D1F] text-white shadow-md font-bold" : "p-3.5 rounded-xl border-2 bg-white text-slate-100 font-bold";
            document.getElementById('btn-leopard').className = state.isLeopard ? "p-3.5 rounded-xl border-2 bg-[#222222] text-white shadow-md font-bold" : "p-3.5 rounded-xl border-2 bg-white text-slate-100 font-bold";
            if(typeof lucide !== 'undefined') lucide.createIcons();
        }

        window.calculateSettlement = () => {
            const today = state.history.filter(r => r.date === state.sessionDate);
            const net = {1:0,2:0,3:0,4:0,5:0}; let dS = today.reduce((a, b) => a + (b.dong || 0), 0);
            today.forEach(r => Object.keys(r.scores).forEach(p => net[p] = (net[p] || 0) + r.scores[p])); net[2] += dS;
            document.getElementById('settle-date-label').textContent = `${state.sessionDate} ç•¶æ—¥çµå¸³`;
            document.getElementById('settle-balances-list').innerHTML = FIXED_PLAYERS.map(p => `<div class="text-center font-bold text-[#222222]"><p class="text-[9px] font-bold opacity-40">${p.name}</p><p class="text-xs ${net[p.id]>=0?'text-[#FF6D1F]':'text-[#222222]'} text-center font-bold">${net[p.id]}</p></div>`).join('');
            const deb = [], cre = []; Object.keys(net).forEach(p => { if(net[p]<0) deb.push({n:getPlayerName(p),a:Math.abs(net[p])}); else if(net[p]>0) cre.push({n:getPlayerName(p),a:net[p]}); });
            const ins = []; let di=0, ci=0;
            while(di < deb.length && ci < cre.length) {
                let s = Math.min(deb[di].a, cre[ci].a); ins.push(`<div class="flex justify-between bg-[#FAF3E1] p-3 rounded-lg border border-[#F5E7C6] text-xs font-bold text-[#222222]"><span>${deb[di].n} ğŸ‘‰ <span class="text-[#FF6D1F]">${cre[ci].n}</span></span><span>$${s}</span></div>`);
                deb[di].a -= s; cre[ci].a -= s; if(deb[di].a===0) di++; if(cre[ci].a===0) ci++;
            }
            document.getElementById('settle-instructions').innerHTML = ins.length ? ins.join('') : '<p class="text-center text-xs opacity-20 italic">å¸³ç›®å¹³è¡¡</p>';
        };

        window.exportToCsv = () => {
            let csv = "\ufeffæ—¥æœŸ,å°‡æ•¸,æ±éŒ¢,ç©å®¶,å¾—åˆ†\n";
            state.history.forEach(r => r.players.forEach(p => csv += `${r.date},ç¬¬${r.roundNumber}å°‡,${r.dong},${getPlayerName(p)},${r.scores[p]}\n`));
            const l = document.createElement("a"); l.href = URL.createObjectURL(new Blob([csv], {type:'text/csv;charset=utf-8;'})); l.download = `é›²ç«¯åŒæ­¥_${state.sessionDate}.csv`; l.click();
        };

        window.resetData = async () => {
            if(!confirm('é€™æœƒæ¸…ç©ºé›²ç«¯æ‰€æœ‰å°å±€æ•¸æ“šï¼Œç¢ºå®šï¼Ÿ')) return;
            const batch = writeBatch(db);
            batch.set(globalRef, { sessionDate: state.sessionDate, selectedPlayerIds:[1,2,3,4], consecutiveWins:{1:0,2:0,3:0,4:0,5:0}, rounds:0, totalDong:0, currentDealerId:null, eyeWatchers:[] });
            const handsSnap = await getDocs(handsColl); handsSnap.forEach(d => batch.delete(d.ref));
            const hiSnap = await getDocs(histColl); hiSnap.forEach(d => batch.delete(d.ref));
            const reSnap = await getDocs(redoColl); reSnap.forEach(d => batch.delete(d.ref));
            await batch.commit();
            location.reload();
        };

        init();
    </script>
</body>
</html>